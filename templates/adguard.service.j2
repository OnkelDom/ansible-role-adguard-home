{{ ansible_managed | comment }}
[Unit]
Description=Adguard Home
Documentation=https://github.com/AdguardTeam/AdGuardHome
After=network-online.target

[Service]
Type=simple
{% if ansible_os_family == "Debian" and ansible_distribution_major_version >= "8" %}
User={{ adguard_system_user }}
{% else %}
User=root
{% endif %}
Group={{ adguard_system_group }}
#ExecReload=/bin/kill -HUP $MAINPID
ExecReload={{ adguard_binary_install_dir }}/adguard --server reload
ExecStart={{ adguard_binary_install_dir }}/adguard \
  --config {{ adguard_config_dir }}/config.yaml \
  --work-dir {{ adguard_db_dir }} \
  --logfile syslog \
  --no-check-update \
  --server run

WorkingDirectory={{ adguard_db_dir }}
SyslogIdentifier=adguard
Restart=always
RestartSec=5
{% if adguard_http_proxy is defined %}
Environment="HTTP_PROXY={{ adguard_http_proxy }}""
{% endif %}
{% if adguard_https_proxy is defined %}
Environment="HTTPS_PROXY={{ adguard_https_proxy }}"
{% endif %}
LimitNOFILE={{ adguard_limit_nofile | default('8192') }}
LimitMEMLOCK=infinity
{% if ansible_os_family == "Debian" and ansible_distribution_major_version >= "8" %}
CapabilityBoundingSet=CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_BIND_SERVICE
{% endif %}
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
